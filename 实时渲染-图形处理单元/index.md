# 图形处理单元


## ***引言***

*第一个包含硬件顶点处理的消费级芯片（NVIDIA GeForce256）于 1999 年发布。*

*NVIDIA 创造了图形处理单元 （graphics processing unit，GPU）这个术语，用来区别 GeForce256 和过去所使用的光栅化芯片，并将这个术语沿用了下来*

*各种可编程的着色器（shader）是控制 GPU 的主要手段。为了获得更高的效率，渲染管线中的有些部分仍然只是可配置的，而并非是可编程的，但是 GPU 的整体发展趋势是可编程性和灵活性。*

*我们需要知道一点，由于在存储中访问数据需要花费一定时间，因此延迟是所有处理器都会面临的一个问题*

## ***数据并行结构***

### ***CPU***

*不同的处理器架构使用了不同的策略来避免停滞。CPU 经过优化，可以处理大量的数据结构和大型代码段，CPU 一般都具有多个处理器，每个处理器都以串行的方式来执行代码。为了最小化延迟所带来的影响，CPU芯片中的大部分面积都是高速的本地缓存，这些缓存中存满了接下来可能会用到的数据。CPU也还会使用一些智能技能来避免停滞，比如 分支预测 等...*

### ***GPU***

*GPU 采用了不同的策略，GPU 芯片中的很大一片面积都是大量的处理器，也叫做着色器核心，GPU芯片中通常会有数千个着色器核心。*

*GPU 是一个流处理器，他会依次处理有序的相似数据。由于数据的相似性（例如一组顶点或者像素），因此 GPU 可以通过大规模并行的方式来处理这些数据*

*GPU 专门对吞吐量（throughput）进行了优化，吞吐量指的是数据能够被处理的最大速度。但是这种快速处理是有代价的，由于用于缓存和控制逻辑的芯片面积较少， 因此每个着色器核心的延迟，通常都会比 CPU 处理器所遇到的延迟要大*

#### ***SIMD***

*当遇到令着色处理器停滞的指令时（例如：对于一个给定的表面位置，程序需要知道纹理上对应位置的像素颜色，而这个纹理是一个独立的资源，并不是像素着色程序本地内存中的一部分， 因此可能会涉及到访问纹理的操作），我们通过切换并执行其他片元程序的方式，来让 GPU 时刻保持忙碌，从而避免延迟。*

*更进一步，GPU 可以将指令执行的逻辑与数据分离开来，这种设计叫做单指令、多数据（single instruction， multiple data，SIMD）*

*这种设计会在固定数量的着色器程序上，以一个固定的步长来执行完全相同的指令*

#### ***wrap / wavefronts***

*每个片元的像素着色器调用都可以被称为一个线程，但是这里所说的线程不同于 CPU 的线程，他还包括用于存储着色其输入数据的存储空间，以及用于着色器执行的任何寄存器空间。这些用相同着色器程序会被打包成组*

*NVDIA将其称为一个 wrap，AMD是称为一个 wavefront*

*一个 warp / wavefronts 负责调度一定数量的 GPU 处理核心， 可能是 8 到 64 个，并且都会使用 SIMD 处理。每个线程都会被映射到一个 SIMD 通 道（SIMD lane）。*

### ***影响 GPU 运行效率的点***

1. *如果线程的数量很少，那么就只能创建很少的 warp，这可能就没法有效隐藏延迟*

2. *影响执行效率的另一个重要特征是着色器程序的结构，其中最重要的一个因素就是每个线程所使用的寄存器数量。*

3. *另一个影响整体运行效率的因素是由`if`语句和循环语句导致的动态分支（dynamic branching）。*

   *假设现在我们的着色器程序中遇到了一个`if`语句，如果所有线程都进入了相同的分支，那么这个 warp 可以不用管其他的分支，继续执行进入的那个分支即可。*

   *但是，如果其中有几个线程，甚至是只有一个线程进入了其他的分支，那么 这个 warp 就必须把两个分支都执行一遍，然后再根据每个线程的具体情况，丢弃不需要的结果。这个问题叫做线程发散（thread divergence），它意味着有 一些线程需要去执行一个循环操作，或者是进入了所在 warp 中其他线程都没有进入 的“if”分支，这会导致其他的线程空转。*

## ***GPU 管线概述***

![GPU 管线概述](https://raw.githubusercontent.com/vlicecream/cloudImage/main/image-20251110135534847.png)

*顶点着色器是一个完全可编程的阶段，它用于实现渲染管线中的几何处理阶段。*

*几何着色器也是一个完全可编程的极端，它可以对图元（点，线，三角形）的顶点进行操作，它也可以用于进行一些逐图元的着色操作，销毁图元或者是创建新图元等*

*曲面细分阶段和几何着色器都是可选的阶段，但并不是所有的 GPU都支持这两个阶段，尤其是移动设备上的 GPU*

*裁剪，三角形设置和三角形遍历阶段，都是由固定功能的硬件进行实现。*

*屏幕映射收到窗口和视口设置的影响，其内部包含了一个简单的缩放和重定位功能。*

*像素着色器阶段是一个完全可编程的阶段*

*合并阶段尽管不是可编程的，但是他是高度可配置的，我们可以为其设定各种各样的操作。合并阶段实现了渲染管线中的合并功能，负责修改维护颜色缓冲，Z-Buffer，模板缓冲以及其他任何与输出相关的缓冲区*

*像素着色器和合并阶段一起，组成了概念化的像素处理阶段*

## ***可编程着色器阶段***

